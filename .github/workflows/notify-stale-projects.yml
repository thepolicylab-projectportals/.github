name: Get email body for stale projects

on:
  workflow_call:
    inputs:
      to:
        type: string
        default: "heather_yu@brown.edu"

permissions:
  contents: read
  packages: read
  pull-requests: write

jobs:
  build:
    runs-on: ubuntu-20.04

    steps:
      - name: Checkout source
        uses: actions/checkout@v3

      - uses: actions/setup-node@v3
        with:
          node-version: 18
          registry-url: https://npm.pkg.github.com/
          scope: '@thepolicylab-projectportals'
          cache: 'yarn'

      - run: yarn config set 'npmRegistries["//npm.pkg.github.com"].npmAuthToken' "${{ secrets.GITHUB_TOKEN }}"

      - run: yarn install --immutable

      - name: Start up app
        run: yarn develop & npx wait-on http://localhost:8000
        
      - run: |
            curl 'http://localhost:8000/___graphql' \
            -X POST \
            -H 'content-type: application/json' \
            --data '{"query": "query { allProject { nodes { id, title, slug, status, opportunityCloses, endDate, startDate, lastModified, mainContact { name, email }  } } }"}' \
            --verbose > query.txt
        id: get_projects
        
      - run: cat query.txt

      - name: Checkout .Github
        uses: actions/checkout@v3
        with: thepolicylab-projectportals/.github
        token: ${{ secrets.GITHUB_TOKEN }}

      - name: Email Body
        id: get_body
        run: node ./get-stale-projects.js query.txt
          
      - name: Send notification email
        uses: dawidd6/action-send-mail@v2
        with:
          # mail server settings
          server_address: smtp.gmail.com
          server_port: 465
          # user credentials
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          # email subject
          subject: Conda install failure for ${{ github.repository }}
          # email body as text
          body: ${{ steps.get_body.outputs.body }}
          # comma-separated string, send email to
          to: ${{ inputs.to }}
          # from email name
          from: Your Friendly Neighborhood Spider-man
